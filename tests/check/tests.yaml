tests:
  - name: this
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user] as self
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
            trace: .(direct).
          - tuple:
              object: document:2
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false

  - name: computed_userset
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer as writer
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
            trace: .(computed-userset).document:1#writer.(direct).
          - tuple:
              object: document:2
              relation: writer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:aardvark
            expectation: false

  - name: tuple_to_userset
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
          
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:x
          - object: folder:x
            relation: viewer
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
            trace: .(tuple-to-userset).document:1#parent.folder:x#viewer.(direct).

  - name: this_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self or writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
            trace: .union.0(direct).
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true

  - name: this_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self and writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: viewer
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: this_and_exclusion_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self but not writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: viewer
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: computed_userset_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer or editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: editor
            user: user:badger
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true

  - name: computed_userset_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer and editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: computed_userset_and_exclusion
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer but not editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: tuple_to_userset_and_computed_userset
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define viewer as writer
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true

  - name: tuple_to_userset_and_tuple_to_userset
    stages:
      - model: |
          type user
          
          type group
            relations
              define member: [user] as self
    
          type folder
            relations
              define parent: [group] as self
              define viewer as member from parent
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: parent
            user: group:G
          - object: group:G
            relation: member
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true

  - name: tuple_to_userset_and_union
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer or editor
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: editor
            user: user:badger
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true

  - name: tuple_to_userset_and_intersection
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer and editor
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: editor
            user: user:aardvark
          - object: folder:X
            relation: writer
            user: user:badger
          - object: folder:X
            relation: editor
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: tuple_to_userset_and_exclusion
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer but not editor
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: editor
            user: user:aardvark
          - object: folder:X
            relation: writer
            user: user:badger
          - object: folder:X
            relation: editor
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: union_and_tuple_to_userset
    stages:
      - model: |
          type user
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as writer or (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:badger
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true

  - name: union_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: owner
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true

  - name: union_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
          - object: document:4
            relation: owner
            user: user:duck
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false

  - name: union_and_exclusion
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor but not owner)
        tuples:
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
          - object: document:4
            relation: owner
            user: user:duck
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false

  - name: intersection_and_tuple_to_userset
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as writer and (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: viewer
            user: user:badger
          - object: document:2
            relation: writer
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: intersection_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer and (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:4
            relation: editor
            user: user:duck
          - object: document:5
            relation: owner
            user: user:eagle
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false

  - name: intersection_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer and (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
          - object: document:5
            relation: editor
            user: user:eagle
          - object: document:6
            relation: owner
            user: user:fox
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false
          - tuple:
              object: document:6
              relation: viewer
              user: user:fox
            expectation: false

  - name: intersection_and_exclusion
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer and (editor but not owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
          - object: document:5
            relation: editor
            user: user:eagle
          - object: document:6
            relation: owner
            user: user:fox
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false
          - tuple:
              object: document:6
              relation: viewer
              user: user:fox
            expectation: false

  - name: exclusion_and_computed_userset
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer but not editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: exclusion_and_tuple_to_userset_in_base
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as (viewer from parent) but not writer
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: viewer
            user: user:badger
          - object: document:2
            relation: writer
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false

  - name: exclusion_and_tuple_to_userset_in_subtract
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as writer but not (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: viewer
            user: user:badger
          - object: document:2
            relation: writer
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: true

  - name: exclusion_and_union_in_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer or editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
          - object: document:5
            relation: editor
            user: user:eagle
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: true
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: true

  - name: exclusion_and_union_in_subtract
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer but not (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true

  - name: exclusion_and_intersection_in_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer and editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:4
            relation: editor
            user: user:duck
          - object: document:5
            relation: owner
            user: user:eagle
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false

  - name: exclusion_and_intersection_in_subtract
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer but not (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: true

  - name: exclusion_and_exclusion_in_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer but not editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true

  - name: exclusion_and_exclusion_in_subtract
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer but not (editor but not owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true

  - name: userset_as_user
    stages:
      - model: |
          type user
          
          type group
            relations
              define member: [user] as self
    
          type document
            relations
              define viewer: [group#member] as self
        tuples:
          - object: document:1
            relation: viewer
            user: group:x#member
          - object: group:x
            relation: member
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: group:x#member
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true

  - name: wildcard_direct
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user:*] as self
        tuples:
          - object: document:public
            relation: viewer
            user: user:*
        assertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:public
              relation: viewer
              user: user:*
            expectation: true

  - name: wildcard_computed_userset
    stages:
      - model: |
          type user

          type document
            relations
              define writer: [user:*] as self
              define viewer: [user] as self or writer
        tuples:
          - object: document:public
            relation: writer
            user: user:*
        assertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            expectation: true

  - name: check_with_invalid_tuple_in_store
    stages:
      - model: |
          type user

          type folder
            relations
              define viewer: [user] as self
          
          type document
            relations
              define parent: [folder] as self
              define viewer: [user] as self or viewer from parent
        tuples:
          - object: folder:x
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: parent
            user: folder:x
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
      - model: |
          type user

          type document
            relations
              define viewer: [user] as self
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false

  - name: this_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user] as self
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
            expectation: true

  - name: computed_userset_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer as writer
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: writer
                user: user:aardvark
            expectation: true

  - name: tuple_to_userset_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
          
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: parent
                user: folder:x
              - object: folder:x
                relation: viewer
                user: user:aardvark
            expectation: true

  - name: this_and_union_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self or writer
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
              - object: document:2
                relation: writer
                user: user:badger
            expectation: true

  - name: this_and_intersection_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self and writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: writer
                user: user:aardvark
            expectation: true

  - name: this_and_exclusion_base_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define banned: [user] as self
              define viewer: [user] as self but not banned
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: banned
                user: user:aardvark
            expectation: false

  - name: union_and_intersection_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor and owner)
        tuples:
          - object: document:1
            relation: editor
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: owner
                user: user:aardvark
            expectation: true

  - name: exclusion_and_exclusion_in_base_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer but not editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
        assertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: editor
                user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:1
                relation: owner
                user: user:aardvark
            expectation: false

  - name: wildcard_direct_as_contextual_tuple
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user:*] as self
        assertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:public
                relation: viewer
                user: user:*
            expectation: true
          - tuple:
              object: document:public
              relation: viewer
              user: user:*
            contextual_tuples:
              - object: document:public
                relation: viewer
                user: user:*
            expectation: true

  - name: wildcard_computed_userset_as_contextual_tuple
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user:*] as self
              define viewer: [user] as self or writer
        assertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            contextual_tuples:
              - object: document:public
                relation: writer
                user: user:*
            expectation: true

