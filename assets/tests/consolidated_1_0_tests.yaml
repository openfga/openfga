tests:
  - name: This
    stages:
      - model: |
          type document
            relations
              define viewer as self
        tuples:
          - object: document:1
            relation: viewer
            user: aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:

  - name: ComputedUserset
    stages:
      - model: |
          type document
            relations
              define writer as self
              define viewer as writer
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: writer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: aardvark
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: aardvark
              type: document
              relation: writer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:

  - name: TupleToUserset
    stages:
      - model: |
          type folder
            relations
              define viewer as self
          type document
            relations
              define parent as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:x
          - object: folder:x
            relation: viewer
            user: aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:

  - name: ThisAndUnion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define viewer as self or writer
        tuples:
          - object: document:1
            relation: viewer
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2

  - name: ThisAndIntersection
    stages:
      - model: |
          type document
            relations
              define writer as self
              define viewer as self and writer
        tuples:
          - object: document:1
            relation: viewer
            user: aardvark
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:2
            relation: viewer
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: aardvark
              type: document
              relation: writer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: ThisAndExclusionBase
    stages:
      - model: |
          type document
            relations
              define writer as self
              define viewer as self but not writer
        tuples:
          - object: document:1
            relation: viewer
            user: aardvark
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:2
            relation: viewer
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: ComputedUsersetAndUnion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define viewer as writer or editor
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:2
            relation: editor
            user: badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2

  - name: ComputedUsersetAndIntersection
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define viewer as writer and editor
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:3
            relation: editor
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: ComputedUsersetAndExclusion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define viewer as writer but not editor
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:3
            relation: editor
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: TupleToUsersetAndComputedUserset
    stages:
      - model: |
          type folder
            relations
              define writer as self
              define viewer as writer
          
          type document
            relations
              define parent as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: TupleToUsersetAndTupleToUserset
    stages:
      - model: |
          type group
            relations
              define member as self
          
          type folder
            relations
              define parent as self
              define viewer as member from parent
          
          type document
            relations
              define parent as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: parent
            user: group:G
          - object: group:G
            relation: member
            user: aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: TupleToUsersetAndUnion
    stages:
      - model: |
          type folder
            relations
              define writer as self
              define editor as self
              define viewer as writer or editor
          
          type document
            relations
              define parent as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: aardvark
          - object: folder:X
            relation: editor
            user: badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: TupleToUsersetAndIntersection
    stages:
      - model: |
          type folder
            relations
              define writer as self
              define editor as self
              define viewer as writer and editor
    
          type document
            relations
              define parent as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: aardvark
          - object: folder:X
            relation: editor
            user: aardvark
          - object: folder:X
            relation: writer
            user: badger
          - object: folder:X
            relation: editor
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: TupleToUsersetAndExclusion
    stages:
      - model: |
          type folder
            relations
              define writer as self
              define editor as self
              define viewer as writer but not editor
    
          type document
            relations
              define parent as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: aardvark
          - object: folder:X
            relation: editor
            user: aardvark
          - object: folder:X
            relation: writer
            user: badger
          - object: folder:X
            relation: editor
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: UnionAndTupleToUserset
    stages:
      - model: |
          type folder
            relations
              define viewer as self
    
          type document
            relations
              define parent as self
              define writer as self
              define viewer as writer or (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: aardvark
          - object: document:1
            relation: writer
            user: badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: UnionAndUnion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer or (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:2
            relation: editor
            user: badger
          - object: document:3
            relation: owner
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: UnionAndIntersection
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer or (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:2
            relation: editor
            user: badger
          - object: document:2
            relation: owner
            user: badger
          - object: document:3
            relation: editor
            user: cheetah
          - object: document:4
            relation: owner
            user: duck
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:

  - name: UnionAndExclusion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer or (editor but not owner)
        tuples:
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:1
            relation: editor
            user: badger
          - object: document:2
            relation: owner
            user: badger
          - object: document:3
            relation: editor
            user: cheetah
          - object: document:4
            relation: owner
            user: duck
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: true
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
              - document:3
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:

  - name: IntersectionAndTupleToUserset
    stages:
      - model: |
          type folder
            relations
              define viewer as self
          
          type document
            relations
              define parent as self
              define writer as self
              define viewer as writer and (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: aardvark
          - object: document:1
            relation: writer
            user: aardvark
          - object: folder:X
            relation: viewer
            user: badger
          - object: document:2
            relation: writer
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: IntersectionAndUnion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer and (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: owner
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
          - object: document:4
            relation: editor
            user: duck
          - object: document:5
            relation: owner
            user: eagle
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: eagle
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: eagle
              type: document
              relation: viewer
            expectation:

  - name: IntersectionAndIntersection
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer and (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:1
            relation: owner
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: editor
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
          - object: document:3
            relation: owner
            user: cheetah
          - object: document:4
            relation: writer
            user: duck
          - object: document:5
            relation: editor
            user: eagle
          - object: document:6
            relation: owner
            user: fox
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: eagle
            expectation: false
          - tuple:
              object: document:6
              relation: viewer
              user: fox
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: eagle
              type: document
              relation: viewer
            expectation:
          - request:
              user: fox
              type: document
              relation: viewer
            expectation:

  - name: IntersectionAndExclusion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer and (editor but not owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:1
            relation: owner
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: editor
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
          - object: document:3
            relation: owner
            user: cheetah
          - object: document:4
            relation: writer
            user: duck
          - object: document:5
            relation: editor
            user: eagle
          - object: document:6
            relation: owner
            user: fox
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: eagle
            expectation: false
          - tuple:
              object: document:6
              relation: viewer
              user: fox
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: eagle
              type: document
              relation: viewer
            expectation:
          - request:
              user: fox
              type: document
              relation: viewer
            expectation:

  - name: ExclusionAndComputedUnion
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define viewer as writer but not editor
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:3
            relation: editor
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: ExclusionAndTupleToUsersetInBase
    stages:
      - model: |
          type folder
            relations
              define viewer as self
          
          type document
            relations
              define parent as self
              define writer as self
              define viewer as (viewer from parent) but not writer
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: aardvark
          - object: document:1
            relation: writer
            user: aardvark
          - object: folder:X
            relation: viewer
            user: badger
          - object: document:2
            relation: writer
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:

  - name: ExclusionAndTupleToUsersetInSubtract
    stages:
      - model: |
          type folder
            relations
              define viewer as self
    
          type document
            relations
              define parent as self
              define writer as self
              define viewer as writer but not (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: aardvark
          - object: document:1
            relation: writer
            user: aardvark
          - object: folder:X
            relation: viewer
            user: badger
          - object: document:2
            relation: writer
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
              - document:2

  - name: ExclusionAndUnionInBase
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as (writer or editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:1
            relation: owner
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: owner
            user: badger
          - object: document:3
            relation: editor
            user: cheetah
          - object: document:3
            relation: owner
            user: cheetah
          - object: document:4
            relation: writer
            user: duck
          - object: document:5
            relation: editor
            user: eagle
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: true
          - tuple:
              object: document:5
              relation: viewer
              user: eagle
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:
              - document:4
          - request:
              user: eagle
              type: document
              relation: viewer
            expectation:
              - document:5

  - name: ExclusionAndUnionInSubtract
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer but not (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: owner
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: ExclusionAndIntersectionInBase
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as (writer and editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:1
            relation: owner
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: editor
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
          - object: document:4
            relation: editor
            user: duck
          - object: document:5
            relation: owner
            user: eagle
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: eagle
            expectation: false
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: eagle
              type: document
              relation: viewer
            expectation:

  - name: ExclusionAndIntersectionInSubtract
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer but not (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:1
            relation: owner
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: editor
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
          - object: document:3
            relation: owner
            user: cheetah
          - object: document:4
            relation: writer
            user: duck
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: true
          - tuple:
              object: document:4
              relation: viewer
              user: duck
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
              - document:3
          - request:
              user: duck
              type: document
              relation: viewer
            expectation:
              - document:4

  - name: ExclusionAndExclusionInBase
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as (writer but not editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: owner
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: ExclusionAndExclusionInSubtract
    stages:
      - model: |
          type document
            relations
              define writer as self
              define editor as self
              define owner as self
              define viewer as writer but not (editor but not owner)
        tuples:
          - object: document:1
            relation: writer
            user: aardvark
          - object: document:1
            relation: editor
            user: aardvark
          - object: document:1
            relation: owner
            user: aardvark
          - object: document:2
            relation: writer
            user: badger
          - object: document:2
            relation: editor
            user: badger
          - object: document:3
            relation: writer
            user: cheetah
          - object: document:3
            relation: owner
            user: cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: userset_as_user
    stages:
      - model: |
          type group
            relations
              define member as self
          
          type document
            relations
              define viewer as self
        tuples:
          - object: document:1
            relation: viewer
            user: group:x#member
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: group:x#member
            expectation: true
        listObjectsAssertions:
          - request:
              user: group:x#member
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: wildcard_direct
    stages:
      - model: |
          type document
            relations
              define viewer as self
        tuples:
          - object: document:public
            relation: viewer
            user: "*"
        checkAssertions:
          - tuple:
              object: document:public
              relation: viewer
              user: aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:
              - document:public

  - name: typed_wildcard_string_is_treated_as_a_literal
    stages:
      - model: |
          type document
            relations
              define viewer as self
        tuples:
          - object: document:1
            relation: viewer
            user: user:*
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:*
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:*
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: aardvark
              type: document
              relation: viewer
            expectation:

  - name: skip_undefined_computed_relations_on_tuplesets
    stages:
      - model: |
          type rule
            relations
              define assigned as self
              define has_assigned as u1 from assigned or u2 from assigned
          type parent1
            relations
              define role as self
              define u1 as role
          type parent2
            relations
              define role as self
              define u2 as role
        checkAssertions:
          - tuple:
              object: rule:X
              relation: has_assigned
              user: user:1
            contextualTuples:
              - object: parent2:a
                relation: role
                user: user:1
              - object: rule:X
                relation: assigned
                user: parent2:a
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:1
              type: rule
              relation: has_assigned
            contextualTuples:
              - object: parent2:a
                relation: role
                user: user:1
              - object: rule:X
                relation: assigned
                user: parent2:a
            expectation:
              - rule:X