tests:
  - name: this
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user] as self
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:

  - name: computed_userset
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer as writer
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: writer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:aardvark
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:aardvark
              type: document
              relation: writer
            expectation:
              - document:1

  - name: tuple_to_userset
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
          
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:x
          - object: folder:x
            relation: viewer
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: this_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self or writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2

  - name: this_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self and writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: viewer
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: this_and_exclusion_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self but not writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: viewer
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: computed_userset_and_computed_userset
    stages:
      - model: |
          type user

          type document
            relations
              define owner: [user] as self
              define writer as owner
              define viewer as writer
        tuples:
          - object: document:1
            relation: owner
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: computed_userset_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer or editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: editor
            user: user:badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2

  - name: computed_userset_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer and editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: computed_userset_and_exclusion
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer but not editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: tuple_to_userset_and_computed_userset
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define viewer as writer
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: tuple_to_userset_and_tuple_to_userset
    stages:
      - model: |
          type user
          
          type group
            relations
              define member: [user] as self
    
          type folder
            relations
              define parent: [group] as self
              define viewer as member from parent
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: parent
            user: group:G
          - object: group:G
            relation: member
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: tuple_to_userset_and_union
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer or editor
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: editor
            user: user:badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: tuple_to_userset_and_intersection
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer and editor
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: editor
            user: user:aardvark
          - object: folder:X
            relation: writer
            user: user:badger
          - object: folder:X
            relation: editor
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: tuple_to_userset_and_exclusion
    stages:
      - model: |
          type user
          
          type folder
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer but not editor
    
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: editor
            user: user:aardvark
          - object: folder:X
            relation: writer
            user: user:badger
          - object: folder:X
            relation: editor
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: union_and_tuple_to_userset
    stages:
      - model: |
          type user
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as writer or (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:badger
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: union_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: owner
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: union_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
          - object: document:4
            relation: owner
            user: user:duck
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:

  - name: union_and_exclusion
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor but not owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
          - object: document:4
            relation: owner
            user: user:duck
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
              - document:3
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:

  - name: intersection_and_tuple_to_userset
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as writer and (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: viewer
            user: user:badger
          - object: document:2
            relation: writer
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: intersection_and_union
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer and (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:4
            relation: editor
            user: user:duck
          - object: document:5
            relation: owner
            user: user:eagle
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:eagle
              type: document
              relation: viewer
            expectation:

  - name: intersection_and_intersection
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer and (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
          - object: document:5
            relation: editor
            user: user:eagle
          - object: document:6
            relation: owner
            user: user:fox
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false
          - tuple:
              object: document:6
              relation: viewer
              user: user:fox
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:eagle
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:fox
              type: document
              relation: viewer
            expectation:

  - name: intersection_and_exclusion
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer and (editor but not owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
          - object: document:5
            relation: editor
            user: user:eagle
          - object: document:6
            relation: owner
            user: user:fox
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false
          - tuple:
              object: document:6
              relation: viewer
              user: user:fox
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:eagle
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:fox
              type: document
              relation: viewer
            expectation:

  - name: exclusion_and_computed_userset
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define viewer as writer but not editor
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: exclusion_and_tuple_to_userset_in_base
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as (viewer from parent) but not writer
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: viewer
            user: user:badger
          - object: document:2
            relation: writer
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:

  - name: exclusion_and_tuple_to_userset_in_subtract
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
    
          type document
            relations
              define parent: [folder] as self
              define writer: [user] as self
              define viewer as writer but not (viewer from parent)
        tuples:
          - object: document:1
            relation: parent
            user: folder:X
          - object: folder:X
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: folder:X
            relation: viewer
            user: user:badger
          - object: document:2
            relation: writer
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
              - document:2

  - name: exclusion_and_union_in_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer or editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: editor
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
          - object: document:5
            relation: editor
            user: user:eagle
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: true
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:
              - document:4
          - request:
              user: user:eagle
              type: document
              relation: viewer
            expectation:
              - document:5

  - name: exclusion_and_union_in_subtract
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer but not (editor or owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: exclusion_and_intersection_in_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer and editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:4
            relation: editor
            user: user:duck
          - object: document:5
            relation: owner
            user: user:eagle
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: false
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: false
          - tuple:
              object: document:5
              relation: viewer
              user: user:eagle
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:eagle
              type: document
              relation: viewer
            expectation:

  - name: exclusion_and_intersection_in_subtract
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer but not (editor and owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
          - object: document:4
            relation: writer
            user: user:duck
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: true
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
          - tuple:
              object: document:4
              relation: viewer
              user: user:duck
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
              - document:2
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
              - document:3
          - request:
              user: user:duck
              type: document
              relation: viewer
            expectation:
              - document:4

  - name: exclusion_and_exclusion_in_base
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer but not editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: owner
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: exclusion_and_exclusion_in_subtract
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer but not (editor but not owner)
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
          - object: document:1
            relation: editor
            user: user:aardvark
          - object: document:1
            relation: owner
            user: user:aardvark
          - object: document:2
            relation: writer
            user: user:badger
          - object: document:2
            relation: editor
            user: user:badger
          - object: document:3
            relation: writer
            user: user:cheetah
          - object: document:3
            relation: owner
            user: user:cheetah
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            expectation: false
          - tuple:
              object: document:3
              relation: viewer
              user: user:cheetah
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:cheetah
              type: document
              relation: viewer
            expectation:
              - document:3

  - name: userset_as_user
    stages:
      - model: |
          type user
          
          type group
            relations
              define member: [user] as self
    
          type document
            relations
              define viewer: [group#member] as self
        tuples:
          - object: document:1
            relation: viewer
            user: group:x#member
          - object: group:x
            relation: member
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: group:x#member
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: group:x#member
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1

  - name: wildcard_direct
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user:*] as self
        tuples:
          - object: document:public
            relation: viewer
            user: user:*
        checkAssertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:public
              relation: viewer
              user: user:*
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:public
          - request:
              user: user:*
              type: document
              relation: viewer
            expectation:
              - document:public

  - name: prior_type_restrictions_ignored
    stages:
      - model: |
          type user

          type document
            relations
              define viewer: [user] as self
        tuples:
          - object: document:1
            relation: viewer
            user: user:jon
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:jon
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:jon
              type: document
              relation: viewer
            expectation:
              - document:1
      - model: |
          type user
          type employee

          type document
            relations
              define viewer: [employee] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:jon
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:jon
              type: document
              relation: viewer
            expectation:

  - name: wildcard_computed_userset
    stages:
      - model: |
          type user
          type document
            relations
              define writer: [user:*] as self
              define viewer: [user] as self or writer
        tuples:
          - object: document:public
            relation: writer
            user: user:*
        checkAssertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:public

  - name: check_with_invalid_tuple_in_store
    stages:
      - model: |
          type user
          type folder
            relations
              define viewer: [user] as self
          
          type document
            relations
              define parent: [folder] as self
              define viewer: [user] as self or viewer from parent
        tuples:
          - object: folder:x
            relation: viewer
            user: user:aardvark
          - object: document:1
            relation: parent
            user: folder:x
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:

  - name: this_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
            expectation:
              - document:1

  - name: computed_userset_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer as writer
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: writer
                user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: writer
                user: user:aardvark
            expectation:
              - document:1

  - name: tuple_to_userset_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type folder
            relations
              define viewer: [user] as self
          
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: parent
                user: folder:x
              - object: folder:x
                relation: viewer
                user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: parent
                user: folder:x
              - object: folder:x
                relation: viewer
                user: user:aardvark
            expectation:
              - document:1

  - name: this_and_union_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self or writer
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
              - object: document:2
                relation: writer
                user: user:badger
            expectation: true
          - tuple:
              object: document:2
              relation: viewer
              user: user:badger
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
              - object: document:2
                relation: writer
                user: user:badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
              - object: document:2
                relation: writer
                user: user:badger
            expectation:
              - document:1
          - request:
              user: user:badger
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:aardvark
              - object: document:2
                relation: writer
                user: user:badger
            expectation:
              - document:2

  - name: this_and_intersection_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define viewer: [user] as self and writer
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: writer
                user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: writer
                user: user:aardvark
            expectation:
              - document:1

  - name: this_and_exclusion_base_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define banned: [user] as self
              define viewer: [user] as self but not banned
        tuples:
          - object: document:1
            relation: viewer
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: banned
                user: user:aardvark
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: banned
                user: user:aardvark
            expectation:

  - name: union_and_intersection_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as writer or (editor and owner)
        tuples:
          - object: document:1
            relation: editor
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: owner
                user: user:aardvark
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: owner
                user: user:aardvark
            expectation:
              - document:1

  - name: exclusion_and_exclusion_in_base_with_contextual_tuples
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user] as self
              define editor: [user] as self
              define owner: [user] as self
              define viewer as (writer but not editor) but not owner
        tuples:
          - object: document:1
            relation: writer
            user: user:aardvark
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: true
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: editor
                user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: owner
                user: user:aardvark
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
              - document:1
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: editor
                user: user:aardvark
            expectation:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:1
                relation: owner
                user: user:aardvark
            expectation:

  - name: wildcard_direct_as_contextual_tuple
    stages:
      - model: |
          type user
          
          type document
            relations
              define viewer: [user:*] as self
        checkAssertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:public
                relation: viewer
                user: user:*
            expectation: true
          - tuple:
              object: document:public
              relation: viewer
              user: user:*
            contextualTuples:
              - object: document:public
                relation: viewer
                user: user:*
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:public
                relation: viewer
                user: user:*
            expectation:
              - document:public
          - request:
              user: user:*
              type: document
              relation: viewer
            contextualTuples:
              - object: document:public
                relation: viewer
                user: user:*
            expectation:
              - document:public

  - name: wildcard_computed_userset_as_contextual_tuple
    stages:
      - model: |
          type user
          
          type document
            relations
              define writer: [user:*] as self
              define viewer: [user] as self or writer
        checkAssertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:public
                relation: writer
                user: user:*
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            contextualTuples:
              - object: document:public
                relation: writer
                user: user:*
            expectation:
              - document:public

  - name: wildcard_and_userset_restriction
    stages:
      - model: |
          type user
          type user2
          type group
            relations
              define member: [user2] as self
          type document
            relations
              define viewer: [user:*, group#member] as self
        tuples:
          - object: document:public
            relation: viewer
            user: user:*
          - object: document:public
            relation: viewer
            user: group:fga#member
          - object: group:fga
            relation: member
            user: user2:bob
        checkAssertions:
          - tuple:
              object: document:public
              relation: viewer
              user: user2:bob
            expectation: true
        listObjectsAssertions:
          - request:
              user: user2:bob
              type: document
              relation: viewer
            expectation:
              - document:public

  - name: wildcard_obeys_the_types_in_stages
    stages:
      - model: |
          type user
          
          type employee
          
          type document
            relations
              define writer: [employee:*] as self
              define viewer: [user] as self or writer
        tuples:
          - object: document:1
            relation: writer
            user: employee:*
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: employee:badger
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: employee:badger
              type: document
              relation: viewer
            expectation:
              - document:1
      - model: |
          type user
          
          type employee
          type document
            relations
              define writer: [user:*] as self
              define viewer: [user] as self or writer
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            expectation: false
          - tuple:
              object: document:1
              relation: viewer
              user: employee:badger
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:aardvark
              type: document
              relation: viewer
            expectation:
          - request:
              user: employee:badger
              type: document
              relation: viewer
            expectation:

  - name: validation_nil_tuple
    stages:
      - model: |
          type user
        checkAssertions:
          - errorCode: 3

  - name: validation_empty_tuple
    stages:
      - model: |
          type user
        checkAssertions:
          - tuple:
              object:
              relation:
              user:
            errorCode: 2009

  - name: validation_empty_object
    stages:
      - model: |
          type user
        checkAssertions:
          - tuple:
              object:
              relation: viewer
              user: user:aardvark
            errorCode: 2009

  - name: validation_empty_relation
    stages:
      - model: |
          type user
        checkAssertions:
          - tuple:
              object: user:aardvark
              relation:
              user: user:badger
            errorCode: 2009

  - name: validation_empty_user
    stages:
      - model: |
          type user
        checkAssertions:
          - tuple:
              object: user:aardvark
              relation: viewer
              user:
            errorCode: 2009

  - name: validation_relation_not_in_model
    stages:
      - model: |
          type user
        checkAssertions:
          - tuple:
              object: user:aardvark
              relation: viewer
              user: user:badger
            errorCode: 2000

  - name: validation_user_type_not_in_model
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: folder:x
            errorCode: 2000

  - name: validation_userset_type_not_in_model
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: folder:x#writer
            errorCode: 2000

  - name: validation_userset_relation_not_in_model
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: document:x#writer
            errorCode: 2000

  - name: validation_user_invalid
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: a:b:c
            errorCode: 2000

  - name: validation_invalid_object_type_in_contextual_tuple
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: folder:x
                relation: viewer
                user: user:aardvark
            errorCode: 2027

  - name: validation_invalid_relation_in_contextual_tuple
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: writer
                user: user:aardvark
            errorCode: 2027

  - name: validation_invalid_user_in_contextual_tuple
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: viewer
                user: employee:aardvark
            errorCode: 2027

  - name: validation_invalid_wildcard_in_contextual_tuple
    stages:
      - model: |
          type user
          type document
            relations
              define viewer: [user] as self
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: viewer
                user: user:*
            errorCode: 2027

  - name: validation_contextual_tuples_and_wildcard_in_ttu_evaluation
    stages:
      - model: |
          type user
          type folder
            relations
              define viewer: [user] as self
          type document
            relations
              define parent: [folder] as self
              define viewer as viewer from parent
        checkAssertions:
          - tuple:
              object: document:1
              relation: viewer
              user: user:aardvark
            contextualTuples:
              - object: document:1
                relation: parent
                user: user:*
            errorCode: 2027

  - name: relations_not_defined_in_some_child_type
    stages:
      - model: |
          type user
          type folder
            relations
              define owner: [user] as self
              define writer: [user,user:*] as self or owner
          type document
            relations
              define can_read as writer from parent
              define parent: [document,folder] as self
              define viewer: [user,user:*] as self
        tuples:
          - user: user:anne
            relation: owner
            object: folder:a
          - user: folder:a
            relation: parent
            object: document:c
          - user: document:c
            relation: parent
            object: document:d
        checkAssertions:
          - tuple:
              user: user:anne
              relation: can_read
              object: document:c
            expectation: true
        listObjectsAssertions:
          - request:
              user: user:anne
              type: document
              relation: can_read
            expectation:
              - document:c

  # https://github.com/openfga/openfga/issues/576
  - name: same_relation_name_different_type
    stages:
      - model: |
          type user
          type folder
            relations
              define owner: [user] as self
              define viewer: [user, user:*] as self or owner
          type document
            relations
              define can_read as viewer from parent
              define parent: [document, folder] as self
              define viewer: [user, user:*] as self
        tuples:
          - user: user:anne
            relation: owner
            object: folder:a
          - user: folder:a
            relation: parent
            object: document:c
          - user: document:c
            relation: parent
            object: document:d
        checkAssertions:
          - tuple:
              user: user:anne
              relation: can_read
              object: document:c
            expectation: true
          - tuple:
              user: user:anne
              relation: can_read
              object: document:d
            expectation: false
        listObjectsAssertions:
          - request:
              user: user:anne
              type: document
              relation: can_read
            expectation:
              #document:d is not expected
              - document:c
